# 1. JVM 内存划分基本概念
通常可以把 JVM 内存区域划分为下面几个方面:
1. 程序计数器, 在 JVM 规范中, 每个线程都有自己的程序计数器, 并且任何时间一个线程都只有一个方法在执行. 程序计数器会存储当前线程正在执行的 Java 方法的 JVM 指令地址; 如果是本地方法, 则是未指定值 `undefined`;
2. Java 虚拟机栈, 每个线程在创建时都会创建一个虚拟机栈, 其内部保存一个个的栈帧, 对应一次次的 Java 方法调用;  
在同一个时间点, 一个线程只会对应一个活动的栈, 叫做当前帧, 方法所在的类叫做当前类. 如果在该方法中调用了其他方法, 对应的新的栈帧会被创建, 成为新的当前栈帧, 直到它返回结果或者执行结束.  
栈帧中存储着局部变量表, 操作数栈, 动态链接, 方法正常退出或者异常退出的定义等.
3. 堆, 它是 Java 内存管理的核心区域, 用来存放 Java 实例对象, 几乎所有创建的 Java 对象实例都会直接分配在堆上, 堆被所有的线程共享, 在 JVM 启动时, 指定的 `Xmx` 之类的参数就是用来指定堆的各种指标.  
此外, 堆也是 GC 终点照顾的区域, 所以堆内空间还会被不同的垃圾收集器进行进一步划分, 包括 `新生代`, `老年代`;
4. 方法区, 一块线程共享的区域, 用于存储元数据, 例如类的结构信息, 以及对应的运行时常量池, 字段, 方法代码等.  
JDK 8 中将永久带移除, 同时增加了元数据区(MetaSpace);
5. 运行时常量池, 方法区的一部分, class 文件中存储的信息包括版本号, 字段, 方法, 属性等, 其中有一项就是常量池, Java 常量池可以存储各种常量信息;
6. 本地方法栈, 支持对本地方法的调用, 与虚拟机栈非常相似.

![](http://oetw0yrii.bkt.clouddn.com/18-7-8/97379211.jpg)

# 2. 永久带被移除的原因
在 JDK 1.8 中, 原有的永久带被移除, 取而代之是元空间, 这么做的原因有以下几点:
1. 字符串存在永久代中，容易出现性能问题和内存溢出。
2. 类及方法的信息等比较难确定其大小，因此对于永久代的大小指定比较困难，太小容易出现永久代溢出，太大则容易导致老年代溢出。
3. 永久代会为 GC 带来不必要的复杂度，并且回收效率偏低。
4. Oracle 可能会将 HotSpot 与 JRockit 合二为一。 

## 2.1 永久带与元空间
元空间: MetaSpace
1. 大部分类元数据都在本地内存中分配。
2. 默认情况下，类元数据只受可用的本地内存限制（容量取决于是32/64位操作系统的可用虚拟内存大小）。
3. 新参数（MaxMetaspaceSize）用于限制本地内存分配给类元数据的大小。如果没有指定这个参数，元空间会在运行时根据需要动态调整。
4. 对于将死的类及类加载器的垃圾回收将在元数据使用达到“MaxMetaspaceSize”参数的设定值时进行。
5. 实时地监控和调整元空间对于减小垃圾回收频率和减少延时是很有必要的。持续的元空间垃圾回收说明，可能存在类、类加载器导致的内存泄漏或是大小设置不合适。

永久带:
1. 这部分内存空间将全部移除。
2. JVM的参数：PermSize 和 MaxPermSize 会被忽略并给出警告（如果在启用时设置了这两个参数）


# 3. OOM

    通俗地说, 导致 OOM 的原因就是 JVM 内存不足.
    JavaDoc 的解释是: 没有空闲内存, 并且垃圾收集器也无法提供更多的内存
    
从 JVM 的角度来看, 除了程序计数器, 其他区域都有可能发生 OOM
- 堆内存不足是最常见的 OOM 原因之一, 抛出的错误信息是 `java.lang.OutOfMemoryError:Java heap space`, 可能的原因有存在内存泄漏, 堆大小不合理等
- 虚拟机栈可能的情况会复杂一些, 过多数量的栈帧会导致 JVM 抛出 `StackOverFlowError`, 如果 JVM 视图去扩展栈空间的时候失败, 则会抛出 OOM;
- 在老版本的 JDK 中, 永久带的大小是有限的, 并且不会像新生代及老年代一样频繁 GC, 所以当我们不断添加新类型的时候, 永久带容易出现 OOM, 尤其是运行时存在大量动态类型生成的场合; 类似 `intern()` 字符串缓存占用太多空间等. 永久带的 OOM 会标记出相应信息 `java.lang.OutOfMemoryError: PermGen space`.
- 新版 JDK 中, 元数据区已经取代了永久带, 相应的 OOM 信息会变成 `java.lang.OutOfMemoryError: Metaspace`